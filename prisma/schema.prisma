datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  name          String
  avatarUrl     String?
  timeZone      String   @default("America/New_York")
  coupleId      String?
  couple        Couple?  @relation(fields: [coupleId], references: [id], onDelete: SetNull)
  isAdmin       Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  calendars     Calendar[]
  events        Event[]
  attendees     Attendee[]
  smtpSetting   SmtpSetting?
  aiAssistantSetting AiAssistantSetting?
  notificationPreference NotificationPreference?
  notifications Notification[]
}

model Couple {
  id               String    @id @default(cuid())
  code             String    @unique
  users            User[]
  sharedCalendar   Calendar?  @relation("SharedCalendar", fields: [sharedCalendarId], references: [id])
  sharedCalendarId String   @unique
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  calendars        Calendar[]
}

enum CalendarType {
  PERSONAL
  SHARED
  EXTERNAL
  IMPORTED
}

model Calendar {
  id           String       @id @default(cuid())
  ownerId      String?
  owner        User?        @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  coupleId     String?
  couple       Couple?      @relation(fields: [coupleId], references: [id])
  sharedInCouple Couple? @relation("SharedCalendar")
  type         CalendarType
  name         String
  color        String        @default("#3b82f6")
  icsUrl       String?       // EXTERNAL
  lastFetched  DateTime?
  etag         String?
  events       Event[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Event {
  id            String   @id @default(cuid())
  calendarId    String
  calendar      Calendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)
  title         String
  description   String?
  location      String?
  startsAtUtc   DateTime
  endsAtUtc     DateTime
  allDay        Boolean  @default(false)
  rrule         String?          // RFC 5545 RRULE
  exdates       String[] @default([]) // ISO dates in event TZ
  visibility    String   @default("owner") // owner | partner
  color         String?
  createdById   String
  createdBy     User     @relation(fields: [createdById], references: [id], onDelete: Cascade)
  attendees     Attendee[]
  source        String   @default("local") // local|external|imported
  externalUid   String?  // stable UID for ICS de-dup
  originalTz    String?  // for expansion
  reminderMinutesBefore Int? // Event-specific reminder time (null = use user default)
  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())
  reminders     EventReminder[]
}

model Attendee {
  id        String  @id @default(cuid())
  eventId   String
  event     Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    String  @default("needsAction") // accepted|declined|tentative|needsAction
}

model SmtpSetting {
  id         String   @id @default(cuid())
  userId     String   @unique
  host       String
  port       Int
  secure     Boolean  @default(true)
  username   String
  password   String   // encrypted
  fromName   String
  fromEmail  String
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AiAssistantSetting {
  id            String   @id @default(cuid())
  userId        String   @unique
  ollamaUrl     String
  selectedModel String?
  useCpu        Boolean  @default(false)
  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model NotificationPreference {
  id                   String   @id @default(cuid())
  userId               String   @unique
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reminderMinutesBefore Int?    // null = disabled
  notifyEmail          Boolean  @default(true)
  notifyWeb            Boolean  @default(true)
  updatedAt            DateTime @updatedAt
  createdAt            DateTime @default(now())
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventId   String?
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model EventReminder {
  id               String   @id @default(cuid())
  eventId          String
  event            Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId           String
  reminderMinutes  Int
  sentAt           DateTime @default(now())
  
  @@unique([eventId, userId, reminderMinutes])
  @@index([userId])
  @@index([eventId])
}
